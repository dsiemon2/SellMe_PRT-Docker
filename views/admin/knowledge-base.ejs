<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Knowledge Base - SellMe PRT Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .sidebar { min-height: 100vh; background: #2c3e50; }
    .sidebar .nav-link { color: rgba(255,255,255,0.8); padding: 0.75rem 1rem; }
    .sidebar .nav-link:hover, .sidebar .nav-link.active { color: #fff; background: rgba(255,255,255,0.1); }
    .sidebar .nav-link i { margin-right: 0.5rem; }
    .main-content { background: #f8f9fa; min-height: 100vh; }
    .nav-divider { border-top: 1px solid rgba(255,255,255,0.2); margin: 0.5rem 0; }
    .nav-section { color: rgba(255,255,255,0.5); font-size: 0.75rem; padding: 0.5rem 1rem; text-transform: uppercase; }

    .kb-card {
      transition: all 0.2s;
      border-left: 4px solid transparent;
    }
    .kb-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .kb-card.type-pdf { border-left-color: #dc3545; }
    .kb-card.type-doc { border-left-color: #0d6efd; }
    .kb-card.type-txt { border-left-color: #6c757d; }
    .kb-card.type-url { border-left-color: #198754; }

    .file-icon {
      width: 48px;
      height: 48px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
    }
    .file-icon.pdf { background: #fce4ec; color: #dc3545; }
    .file-icon.doc { background: #e3f2fd; color: #0d6efd; }
    .file-icon.txt { background: #f5f5f5; color: #6c757d; }
    .file-icon.url { background: #e8f5e9; color: #198754; }

    .upload-zone {
      border: 2px dashed #dee2e6;
      border-radius: 12px;
      padding: 2rem;
      text-align: center;
      transition: all 0.2s;
      cursor: pointer;
    }
    .upload-zone:hover, .upload-zone.dragover {
      border-color: #0d6efd;
      background: rgba(13, 110, 253, 0.05);
    }

    .bulk-actions { display: none; background: #e3f2fd; padding: 0.75rem 1rem; border-radius: 8px; }
    .bulk-actions.show { display: flex; align-items: center; }
    tr.selected { background-color: #e3f2fd !important; }

    .lang-badge {
      font-size: 0.7rem;
      padding: 0.25rem 0.5rem;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <%- include('_sidebar', { token, active: 'knowledge-base' }) %>

      <main class="col-md-10 ms-sm-auto main-content p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <div>
            <h2><i class="bi bi-book text-primary me-2"></i>Knowledge Base</h2>
            <p class="text-muted mb-0">Upload documents to train your AI assistant with company-specific knowledge.</p>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addUrlModal">
              <i class="bi bi-link-45deg"></i> Add URL
            </button>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
              <i class="bi bi-cloud-upload"></i> Upload Files
            </button>
          </div>
        </div>

        <!-- Stats Cards -->
        <div class="row g-3 mb-4">
          <div class="col-md-3 col-6">
            <div class="card text-center h-100">
              <div class="card-body">
                <i class="bi bi-file-earmark-text text-primary" style="font-size: 2rem;"></i>
                <h3 class="mt-2 mb-0"><%= documents.length %></h3>
                <small class="text-muted">Total Documents</small>
              </div>
            </div>
          </div>
          <div class="col-md-3 col-6">
            <div class="card text-center h-100">
              <div class="card-body">
                <i class="bi bi-hdd text-info" style="font-size: 2rem;"></i>
                <h3 class="mt-2 mb-0"><%= totalSize %></h3>
                <small class="text-muted">Total Size</small>
              </div>
            </div>
          </div>
          <div class="col-md-3 col-6">
            <div class="card text-center h-100">
              <div class="card-body">
                <i class="bi bi-translate text-success" style="font-size: 2rem;"></i>
                <h3 class="mt-2 mb-0"><%= languageCount %></h3>
                <small class="text-muted">Languages</small>
              </div>
            </div>
          </div>
          <div class="col-md-3 col-6">
            <div class="card text-center h-100">
              <div class="card-body">
                <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
                <h3 class="mt-2 mb-0"><%= documents.filter(d => d.status === 'processed').length %></h3>
                <small class="text-muted">Processed</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Filter by Language -->
        <div class="card mb-4">
          <div class="card-body py-2">
            <div class="d-flex align-items-center gap-2 flex-wrap">
              <span class="text-muted me-2"><i class="bi bi-funnel"></i> Filter:</span>
              <a href="<%= basePath || '/SellMePRT' %>/admin/knowledge-base?token=<%= token %>" class="btn btn-sm <%= !currentLanguage ? 'btn-primary' : 'btn-outline-primary' %>">All</a>
              <% languages.forEach(lang => { %>
              <a href="<%= basePath || '/SellMePRT' %>/admin/knowledge-base?language=<%= lang.code %>&token=<%= token %>"
                 class="btn btn-sm <%= currentLanguage === lang.code ? 'btn-primary' : 'btn-outline-secondary' %>">
                <%= lang.flag %> <%= lang.name %>
              </a>
              <% }) %>
            </div>
          </div>
        </div>

        <!-- Bulk Actions -->
        <div class="bulk-actions mb-3" id="bulkActions">
          <span class="me-3"><strong id="selectedCount">0</strong> selected</span>
          <button class="btn btn-sm btn-outline-danger" onclick="bulkDelete()" data-bs-toggle="tooltip" title="Delete selected documents">
            <i class="bi bi-trash"></i> Delete Selected
          </button>
          <button class="btn btn-sm btn-outline-secondary ms-2" onclick="bulkReprocess()" data-bs-toggle="tooltip" title="Reprocess selected documents">
            <i class="bi bi-arrow-repeat"></i> Reprocess
          </button>
        </div>

        <!-- Documents Table -->
        <div class="card">
          <div class="card-body p-0">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th style="width: 40px;">
                    <input type="checkbox" class="form-check-input" id="selectAll" data-bs-toggle="tooltip" title="Select all">
                  </th>
                  <th>Document</th>
                  <th>Language</th>
                  <th>Type</th>
                  <th>Size</th>
                  <th>Status</th>
                  <th>Uploaded</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% if (documents.length > 0) { %>
                  <% documents.forEach(doc => { %>
                  <tr data-id="<%= doc.id %>">
                    <td><input type="checkbox" class="form-check-input row-checkbox" value="<%= doc.id %>"></td>
                    <td>
                      <div class="d-flex align-items-center">
                        <div class="file-icon <%= doc.type %> me-3">
                          <i class="bi bi-<%= doc.type === 'pdf' ? 'file-earmark-pdf' : doc.type === 'doc' ? 'file-earmark-word' : doc.type === 'url' ? 'link-45deg' : 'file-earmark-text' %>"></i>
                        </div>
                        <div>
                          <strong><%= doc.name %></strong>
                          <% if (doc.description) { %>
                          <br><small class="text-muted"><%= doc.description.substring(0, 50) %><%= doc.description.length > 50 ? '...' : '' %></small>
                          <% } %>
                        </div>
                      </div>
                    </td>
                    <td>
                      <span class="badge lang-badge bg-secondary"><%= doc.languageFlag %> <%= doc.languageCode.toUpperCase() %></span>
                    </td>
                    <td>
                      <span class="badge bg-<%= doc.type === 'pdf' ? 'danger' : doc.type === 'doc' ? 'primary' : doc.type === 'url' ? 'success' : 'secondary' %>">
                        <%= doc.type.toUpperCase() %>
                      </span>
                    </td>
                    <td><%= doc.size %></td>
                    <td>
                      <% if (doc.status === 'processed') { %>
                      <span class="badge bg-success"><i class="bi bi-check-circle"></i> Processed</span>
                      <% } else if (doc.status === 'processing') { %>
                      <span class="badge bg-warning"><i class="bi bi-hourglass-split"></i> Processing</span>
                      <% } else if (doc.status === 'error') { %>
                      <span class="badge bg-danger"><i class="bi bi-x-circle"></i> Error</span>
                      <% } else { %>
                      <span class="badge bg-secondary"><i class="bi bi-clock"></i> Pending</span>
                      <% } %>
                    </td>
                    <td>
                      <small class="text-muted"><%= new Date(doc.createdAt).toLocaleDateString() %></small>
                    </td>
                    <td>
                      <button class="btn btn-sm btn-outline-info me-1" onclick="viewDocument('<%= doc.id %>')" data-bs-toggle="tooltip" title="View details">
                        <i class="bi bi-eye"></i>
                      </button>
                      <button class="btn btn-sm btn-outline-secondary me-1" onclick="reprocessDocument('<%= doc.id %>')" data-bs-toggle="tooltip" title="Reprocess document">
                        <i class="bi bi-arrow-repeat"></i>
                      </button>
                      <button class="btn btn-sm btn-outline-danger" onclick="deleteDocument('<%= doc.id %>')" data-bs-toggle="tooltip" title="Delete document">
                        <i class="bi bi-trash"></i>
                      </button>
                    </td>
                  </tr>
                  <% }) %>
                <% } else { %>
                <tr>
                  <td colspan="8" class="text-center py-5">
                    <i class="bi bi-file-earmark-x text-muted" style="font-size: 3rem;"></i>
                    <h5 class="mt-3">No Documents Yet</h5>
                    <p class="text-muted">Upload documents or add URLs to build your AI's knowledge base.</p>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                      <i class="bi bi-cloud-upload"></i> Upload Files
                    </button>
                  </td>
                </tr>
                <% } %>
              </tbody>
            </table>
          </div>
          <% if (documents.length > 0) { %>
          <div class="card-footer bg-white d-flex justify-content-between align-items-center">
            <small class="text-muted">Showing <%= documents.length %> documents</small>
            <select class="form-select form-select-sm" style="width: auto;">
              <option value="10">10 / page</option>
              <option value="25">25 / page</option>
              <option value="50">50 / page</option>
            </select>
          </div>
          <% } %>
        </div>

        <!-- Supported Formats Info -->
        <div class="card mt-4">
          <div class="card-header bg-light">
            <h6 class="mb-0"><i class="bi bi-info-circle me-2"></i>Supported Formats</h6>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-3 col-6 mb-3">
                <div class="d-flex align-items-center">
                  <div class="file-icon pdf me-2" style="width: 36px; height: 36px; font-size: 1rem;">
                    <i class="bi bi-file-earmark-pdf"></i>
                  </div>
                  <div>
                    <strong>PDF</strong>
                    <br><small class="text-muted">Documents, manuals</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3 col-6 mb-3">
                <div class="d-flex align-items-center">
                  <div class="file-icon doc me-2" style="width: 36px; height: 36px; font-size: 1rem;">
                    <i class="bi bi-file-earmark-word"></i>
                  </div>
                  <div>
                    <strong>DOCX</strong>
                    <br><small class="text-muted">Word documents</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3 col-6 mb-3">
                <div class="d-flex align-items-center">
                  <div class="file-icon txt me-2" style="width: 36px; height: 36px; font-size: 1rem;">
                    <i class="bi bi-file-earmark-text"></i>
                  </div>
                  <div>
                    <strong>TXT/MD</strong>
                    <br><small class="text-muted">Plain text, markdown</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3 col-6 mb-3">
                <div class="d-flex align-items-center">
                  <div class="file-icon url me-2" style="width: 36px; height: 36px; font-size: 1rem;">
                    <i class="bi bi-link-45deg"></i>
                  </div>
                  <div>
                    <strong>URLs</strong>
                    <br><small class="text-muted">Web pages, articles</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Upload Modal -->
  <div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-cloud-upload me-2"></i>Upload Documents</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="upload-zone mb-4" id="uploadZone">
            <i class="bi bi-cloud-arrow-up text-muted" style="font-size: 3rem;"></i>
            <h5 class="mt-3">Drag & drop files here</h5>
            <p class="text-muted mb-3">or click to browse</p>
            <input type="file" id="fileInput" class="d-none" multiple accept=".pdf,.doc,.docx,.txt,.md">
            <button class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click()">
              <i class="bi bi-folder2-open"></i> Browse Files
            </button>
          </div>

          <div class="mb-3">
            <label class="form-label">Language</label>
            <select class="form-select" id="uploadLanguage">
              <% languages.forEach(lang => { %>
              <option value="<%= lang.code %>" <%= lang.code === 'en' ? 'selected' : '' %>><%= lang.flag %> <%= lang.name %></option>
              <% }) %>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Description (optional)</label>
            <input type="text" class="form-control" id="uploadDescription" placeholder="Brief description of the document content">
          </div>

          <div id="fileList" class="d-none">
            <h6>Selected Files:</h6>
            <ul class="list-group" id="selectedFiles"></ul>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="uploadFiles()" id="uploadBtn" disabled>
            <i class="bi bi-cloud-upload"></i> Upload
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add URL Modal -->
  <div class="modal fade" id="addUrlModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-link-45deg me-2"></i>Add URL</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">URL *</label>
            <input type="url" class="form-control" id="urlInput" placeholder="https://example.com/page" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Name</label>
            <input type="text" class="form-control" id="urlName" placeholder="Document name (auto-detected if blank)">
          </div>
          <div class="mb-3">
            <label class="form-label">Language</label>
            <select class="form-select" id="urlLanguage">
              <% languages.forEach(lang => { %>
              <option value="<%= lang.code %>" <%= lang.code === 'en' ? 'selected' : '' %>><%= lang.flag %> <%= lang.name %></option>
              <% }) %>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Description (optional)</label>
            <input type="text" class="form-control" id="urlDescription" placeholder="Brief description">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="addUrl()">
            <i class="bi bi-plus-lg"></i> Add URL
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- View Document Modal -->
  <div class="modal fade" id="viewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-file-earmark-text me-2"></i>Document Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row mb-3">
            <div class="col-md-6">
              <small class="text-muted d-block">Name</small>
              <strong id="viewName"></strong>
            </div>
            <div class="col-md-6">
              <small class="text-muted d-block">Type</small>
              <span id="viewType" class="badge"></span>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <small class="text-muted d-block">Language</small>
              <span id="viewLanguage"></span>
            </div>
            <div class="col-md-6">
              <small class="text-muted d-block">Size</small>
              <span id="viewSize"></span>
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-6">
              <small class="text-muted d-block">Status</small>
              <span id="viewStatus" class="badge"></span>
            </div>
            <div class="col-md-6">
              <small class="text-muted d-block">Uploaded</small>
              <span id="viewDate"></span>
            </div>
          </div>
          <div class="mb-3" id="viewDescriptionSection">
            <small class="text-muted d-block">Description</small>
            <span id="viewDescription"></span>
          </div>
          <div class="mb-3" id="viewContentSection">
            <small class="text-muted d-block">Content Preview</small>
            <div class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">
              <pre id="viewContent" class="mb-0" style="white-space: pre-wrap;"></pre>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const token = '<%= token %>';
    const basePath = '<%= basePath || "/SellMePRT" %>';
    let selectedFiles = [];

    document.addEventListener('DOMContentLoaded', () => {
      // Initialize tooltips
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
      tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

      // Select all checkbox
      document.getElementById('selectAll')?.addEventListener('change', function() {
        document.querySelectorAll('.row-checkbox').forEach(cb => {
          cb.checked = this.checked;
          cb.closest('tr').classList.toggle('selected', this.checked);
        });
        updateBulkActions();
      });

      // Row checkboxes
      document.querySelectorAll('.row-checkbox').forEach(cb => {
        cb.addEventListener('change', function() {
          this.closest('tr').classList.toggle('selected', this.checked);
          updateBulkActions();
        });
      });

      // File input
      const fileInput = document.getElementById('fileInput');
      fileInput?.addEventListener('change', handleFileSelect);

      // Drag and drop
      const uploadZone = document.getElementById('uploadZone');
      if (uploadZone) {
        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          uploadZone.classList.add('dragover');
        });
        uploadZone.addEventListener('dragleave', () => {
          uploadZone.classList.remove('dragover');
        });
        uploadZone.addEventListener('drop', (e) => {
          e.preventDefault();
          uploadZone.classList.remove('dragover');
          handleFileSelect({ target: { files: e.dataTransfer.files } });
        });
      }
    });

    function updateBulkActions() {
      const checked = document.querySelectorAll('.row-checkbox:checked').length;
      document.getElementById('selectedCount').textContent = checked;
      document.getElementById('bulkActions').classList.toggle('show', checked > 0);
    }

    function handleFileSelect(e) {
      selectedFiles = Array.from(e.target.files);
      const fileList = document.getElementById('fileList');
      const selectedFilesEl = document.getElementById('selectedFiles');

      if (selectedFiles.length > 0) {
        fileList.classList.remove('d-none');
        selectedFilesEl.innerHTML = selectedFiles.map(f => `
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span><i class="bi bi-file-earmark me-2"></i>${f.name}</span>
            <span class="badge bg-secondary">${formatFileSize(f.size)}</span>
          </li>
        `).join('');
        document.getElementById('uploadBtn').disabled = false;
      } else {
        fileList.classList.add('d-none');
        document.getElementById('uploadBtn').disabled = true;
      }
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    async function uploadFiles() {
      const formData = new FormData();
      selectedFiles.forEach(f => formData.append('files', f));
      formData.append('language', document.getElementById('uploadLanguage').value);
      formData.append('description', document.getElementById('uploadDescription').value);

      try {
        const res = await fetch(`${basePath}/admin/knowledge-base/upload?token=${token}`, {
          method: 'POST',
          body: formData
        });

        if (res.ok) {
          location.reload();
        } else {
          alert('Failed to upload files');
        }
      } catch (err) {
        console.error(err);
        alert('Error uploading files');
      }
    }

    async function addUrl() {
      const url = document.getElementById('urlInput').value;
      if (!url) {
        alert('Please enter a URL');
        return;
      }

      try {
        const res = await fetch(`${basePath}/admin/knowledge-base/url?token=${token}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            url,
            name: document.getElementById('urlName').value,
            language: document.getElementById('urlLanguage').value,
            description: document.getElementById('urlDescription').value
          })
        });

        if (res.ok) {
          location.reload();
        } else {
          alert('Failed to add URL');
        }
      } catch (err) {
        console.error(err);
        alert('Error adding URL');
      }
    }

    async function viewDocument(id) {
      try {
        const res = await fetch(`${basePath}/admin/knowledge-base/${id}?token=${token}`);
        const data = await res.json();

        if (data.success) {
          const doc = data.document;
          document.getElementById('viewName').textContent = doc.name;
          document.getElementById('viewType').textContent = doc.type.toUpperCase();
          document.getElementById('viewType').className = `badge bg-${doc.type === 'pdf' ? 'danger' : doc.type === 'doc' ? 'primary' : doc.type === 'url' ? 'success' : 'secondary'}`;
          document.getElementById('viewLanguage').textContent = `${doc.languageFlag} ${doc.languageCode.toUpperCase()}`;
          document.getElementById('viewSize').textContent = doc.size;
          document.getElementById('viewStatus').textContent = doc.status;
          document.getElementById('viewStatus').className = `badge bg-${doc.status === 'processed' ? 'success' : doc.status === 'error' ? 'danger' : 'warning'}`;
          document.getElementById('viewDate').textContent = new Date(doc.createdAt).toLocaleString();

          if (doc.description) {
            document.getElementById('viewDescriptionSection').style.display = 'block';
            document.getElementById('viewDescription').textContent = doc.description;
          } else {
            document.getElementById('viewDescriptionSection').style.display = 'none';
          }

          if (doc.content) {
            document.getElementById('viewContentSection').style.display = 'block';
            document.getElementById('viewContent').textContent = doc.content.substring(0, 2000) + (doc.content.length > 2000 ? '...' : '');
          } else {
            document.getElementById('viewContentSection').style.display = 'none';
          }

          new bootstrap.Modal(document.getElementById('viewModal')).show();
        }
      } catch (err) {
        console.error(err);
        alert('Failed to load document');
      }
    }

    async function deleteDocument(id) {
      if (!confirm('Are you sure you want to delete this document?')) return;

      try {
        const res = await fetch(`${basePath}/admin/knowledge-base/${id}?token=${token}`, { method: 'DELETE' });
        if (res.ok) {
          location.reload();
        }
      } catch (err) {
        console.error(err);
        alert('Failed to delete document');
      }
    }

    async function reprocessDocument(id) {
      try {
        const res = await fetch(`${basePath}/admin/knowledge-base/${id}/reprocess?token=${token}`, { method: 'POST' });
        if (res.ok) {
          location.reload();
        }
      } catch (err) {
        console.error(err);
        alert('Failed to reprocess document');
      }
    }

    async function bulkDelete() {
      const ids = Array.from(document.querySelectorAll('.row-checkbox:checked')).map(cb => cb.value);
      if (ids.length === 0) return;

      if (!confirm(`Delete ${ids.length} document(s)?`)) return;

      try {
        const res = await fetch(`${basePath}/admin/knowledge-base/bulk-delete?token=${token}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids })
        });
        if (res.ok) {
          location.reload();
        }
      } catch (err) {
        console.error(err);
        alert('Failed to delete documents');
      }
    }

    async function bulkReprocess() {
      const ids = Array.from(document.querySelectorAll('.row-checkbox:checked')).map(cb => cb.value);
      if (ids.length === 0) return;

      try {
        const res = await fetch(`${basePath}/admin/knowledge-base/bulk-reprocess?token=${token}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ids })
        });
        if (res.ok) {
          location.reload();
        }
      } catch (err) {
        console.error(err);
        alert('Failed to reprocess documents');
      }
    }
  </script>
</body>
</html>
