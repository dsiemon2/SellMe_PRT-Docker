<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics - Sell Me a Pen Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .sidebar { min-height: 100vh; background: #2c3e50; }
    .sidebar .nav-link { color: rgba(255,255,255,0.8); padding: 0.75rem 1rem; }
    .sidebar .nav-link:hover, .sidebar .nav-link.active { color: #fff; background: rgba(255,255,255,0.1); }
    .sidebar .nav-link i { margin-right: 0.5rem; }
    .main-content { background: #f8f9fa; min-height: 100vh; }
    .nav-divider { border-top: 1px solid rgba(255,255,255,0.2); margin: 0.5rem 0; }
    .nav-section { color: rgba(255,255,255,0.5); font-size: 0.75rem; padding: 0.5rem 1rem; text-transform: uppercase; }
    .stat-card { border-radius: 12px; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <%- include('_sidebar', { token, active: 'analytics' }) %>

      <main class="col-md-10 ms-sm-auto main-content p-4">
        <h2 class="mb-4"><i class="bi bi-graph-up text-primary me-2"></i>Analytics & Learning</h2>

        <!-- Overview Stats -->
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="card stat-card border-0 shadow-sm">
              <div class="card-body text-center">
                <h3 class="text-primary"><%= stats.totalSessions %></h3>
                <small class="text-muted">Total Sessions</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card stat-card border-0 shadow-sm">
              <div class="card-body text-center">
                <h3 class="text-success"><%= stats.salesMade %></h3>
                <small class="text-muted">Sales Made</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card stat-card border-0 shadow-sm">
              <div class="card-body text-center">
                <h3 class="text-danger"><%= stats.noSale %></h3>
                <small class="text-muted">No Sale</small>
              </div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="card stat-card border-0 shadow-sm">
              <div class="card-body text-center">
                <h3 class="text-info"><%= stats.conversionRate %>%</h3>
                <small class="text-muted">Conversion Rate</small>
              </div>
            </div>
          </div>
        </div>

        <div class="row mb-4">
          <!-- Outcome Distribution Chart -->
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-light">
                <h6 class="mb-0"><i class="bi bi-pie-chart me-2"></i>Session Outcomes</h6>
              </div>
              <div class="card-body">
                <canvas id="outcomeChart" height="200"></canvas>
              </div>
            </div>
          </div>

          <!-- Top Techniques -->
          <div class="col-md-6">
            <div class="card">
              <div class="card-header bg-light">
                <h6 class="mb-0"><i class="bi bi-trophy me-2"></i>Top Performing Techniques</h6>
              </div>
              <div class="card-body">
                <% if (techniques.length > 0) { %>
                  <% techniques.slice(0, 5).forEach((tech, idx) => { %>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <div>
                        <span class="badge bg-primary me-2"><%= idx + 1 %></span>
                        <%= tech.name.replace(/_/g, ' ') %>
                      </div>
                      <div>
                        <span class="badge bg-success"><%= tech.successCount %> wins</span>
                        <small class="text-muted ms-2"><%= tech.usageCount %> uses</small>
                      </div>
                    </div>
                  <% }) %>
                <% } else { %>
                  <p class="text-muted text-center py-3">No technique data yet.</p>
                <% } %>
              </div>
            </div>
          </div>
        </div>

        <!-- Learning Insights -->
        <div class="card mb-4">
          <div class="card-header bg-light">
            <h6 class="mb-0"><i class="bi bi-lightbulb me-2"></i>AI Learning Insights</h6>
          </div>
          <div class="card-body">
            <% if (insights.length > 0) { %>
              <ul class="list-group list-group-flush">
                <% insights.forEach(insight => { %>
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                      <span class="badge bg-info me-2"><%= insight.type %></span>
                      <%= insight.insight %>
                    </div>
                    <small class="text-muted">Based on <%= insight.basedOn %> sessions</small>
                  </li>
                <% }) %>
              </ul>
            <% } else { %>
              <div class="text-center py-4">
                <i class="bi bi-robot text-muted" style="font-size: 3rem;"></i>
                <p class="text-muted mt-2">The AI is still learning. Insights will appear as more sessions complete.</p>
              </div>
            <% } %>
          </div>
        </div>

        <!-- Conversion Trends -->
        <div class="card">
          <div class="card-header bg-light">
            <h6 class="mb-0"><i class="bi bi-graph-up-arrow me-2"></i>How the System Learns</h6>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-4 text-center border-end">
                <i class="bi bi-chat-dots text-primary" style="font-size: 2rem;"></i>
                <h6 class="mt-2">Track Conversations</h6>
                <p class="text-muted small">Every session is logged with full conversation history and outcomes.</p>
              </div>
              <div class="col-md-4 text-center border-end">
                <i class="bi bi-bar-chart text-success" style="font-size: 2rem;"></i>
                <h6 class="mt-2">Measure Techniques</h6>
                <p class="text-muted small">Success rates are calculated for each sales technique used.</p>
              </div>
              <div class="col-md-4 text-center">
                <i class="bi bi-gear text-info" style="font-size: 2rem;"></i>
                <h6 class="mt-2">Optimize Strategy</h6>
                <p class="text-muted small">AI adapts to use higher-performing techniques more often.</p>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Initialize tooltips
    document.addEventListener('DOMContentLoaded', () => {
      const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
      tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));
    });

    // Outcome distribution chart
    const outcomeCtx = document.getElementById('outcomeChart').getContext('2d');
    new Chart(outcomeCtx, {
      type: 'doughnut',
      data: {
        labels: ['Sales Made', 'No Sale', 'Abandoned'],
        datasets: [{
          data: [<%= stats.salesMade %>, <%= stats.noSale %>, <%= stats.abandoned %>],
          backgroundColor: ['#198754', '#dc3545', '#ffc107']
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });
  </script>
</body>
</html>
