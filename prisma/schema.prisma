generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// SALES SESSIONS - Track each training session
// ============================================

model SalesSession {
  id              String   @id @default(cuid())
  sessionId       String   @unique
  userName        String?
  startedAt       DateTime @default(now())
  endedAt         DateTime?
  outcome         String   @default("in_progress") // in_progress, sale_made, no_sale, abandoned
  saleConfirmed   Boolean  @default(false)
  currentPhase    String   @default("greeting") // greeting, discovery, positioning, closing, completed
  userNeeds       String   @default("{}") // JSON: discovered user preferences
  techniquesUsed  String   @default("[]") // JSON array of techniques used
  closingAttempts Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  messages        Message[]
  analytics       SessionAnalytics?
}

model Message {
  id            String       @id @default(cuid())
  sessionId     String
  session       SalesSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  role          String       // user, assistant, system
  content       String
  phase         String?      // Which sales phase this message was in
  sentiment     String?      // positive, negative, neutral, interested, skeptical
  keywords      String       @default("[]") // JSON array of detected keywords
  createdAt     DateTime     @default(now())
}

// ============================================
// SESSION ANALYTICS - Learning data per session
// ============================================

model SessionAnalytics {
  id                    String       @id @default(cuid())
  sessionId             String       @unique
  session               SalesSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  totalMessages         Int          @default(0)
  userMessageCount      Int          @default(0)
  aiMessageCount        Int          @default(0)
  avgResponseLength     Float        @default(0)
  discoveryQuestionsAsked Int        @default(0)
  objectionCount        Int          @default(0)
  positiveSignals       Int          @default(0)
  negativeSignals       Int          @default(0)
  timeToFirstInterest   Int?         // Seconds until first positive signal
  timeToClose           Int?         // Seconds until sale confirmed
  successfulTechniques  String       @default("[]") // JSON array
  failedTechniques      String       @default("[]") // JSON array
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
}

// ============================================
// CONFIGURATION - Admin configurable settings
// ============================================

model AppConfig {
  id                  String   @id @default(cuid())
  appName             String   @default("AI Sales Training")
  greeting            String   @default("Welcome to AI Sales, Sell Me a Pen Training App! When you're ready, just say 'Sell me a pen' to begin your training session.")
  triggerPhrase       String   @default("sell me a pen")
  selectedVoice       String   @default("alloy")
  aiPersona           String   @default("confident, friendly sales professional")
  successKeywords     String   @default("[\"yes\", \"i'll take it\", \"i'll buy it\", \"sold\", \"deal\", \"i want it\", \"sign me up\", \"where do i sign\", \"take my money\", \"i'm in\", \"let's do it\", \"you got me\"]")
  objectionKeywords   String   @default("[\"no\", \"not interested\", \"too expensive\", \"i don't need\", \"maybe later\", \"let me think\", \"not now\"]")
  maxClosingAttempts  Int      @default(3)
  // Mode: ai_sells (AI is salesperson) or user_sells (User is salesperson)
  salesMode           String   @default("ai_sells")
  // Difficulty for user_sells mode: easy, medium, hard, expert
  difficulty          String   @default("medium")
  // Primary language code
  primaryLanguage     String   @default("en")
  updatedAt           DateTime @updatedAt
}

// ============================================
// LANGUAGES - Multi-language support
// ============================================

model Language {
  id          String   @id @default(cuid())
  code        String   @unique // en, es, fr, de, etc.
  name        String   // English, Spanish, French, etc.
  nativeName  String   // English, Espa√±ol, Fran√ßais, etc.
  flag        String   @default("üåê") // Emoji flag
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// PEN PRODUCT - The pen being sold
// ============================================

model PenProduct {
  id              String   @id @default(cuid())
  name            String   @default("Executive Signature Pen")
  tagline         String   @default("Make Every Signature Count")
  basePrice       Float    @default(49.99)
  premiumPrice    Float    @default(129.99)
  features        String   @default("[\"Precision-engineered tungsten carbide tip\", \"German-engineered ink flow system\", \"Aircraft-grade aluminum body\", \"Lifetime warranty\", \"Personalized engraving available\"]")
  benefits        String   @default("[\"Projects confidence and professionalism\", \"Never skips or smears\", \"Comfortable for extended writing\", \"Makes a lasting impression\", \"Perfect balance and weight\"]")
  variants        String   @default("[\"Matte Black\", \"Brushed Silver\", \"Rose Gold\", \"Carbon Fiber\"]")
  scarcityMessage String   @default("Limited edition - only 50 remain in this finish")
  updatedAt       DateTime @updatedAt
}

// ============================================
// SALES TECHNIQUES - Configurable strategies
// ============================================

model SalesTechnique {
  id          String   @id @default(cuid())
  name        String   @unique
  category    String   // discovery, positioning, persuasion, closing, objection_handling
  description String
  script      String   // Example script/approach
  enabled     Boolean  @default(true)
  successRate Float    @default(0) // Calculated from analytics
  usageCount  Int      @default(0)
  successCount Int     @default(0)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// DISCOVERY QUESTIONS - Questions to ask users
// ============================================

model DiscoveryQuestion {
  id          String   @id @default(cuid())
  question    String
  purpose     String   // What this question reveals (e.g., "identifies writing frequency")
  followUp    String?  // Suggested follow-up question
  targetNeed  String   // Which need this addresses: professionalism, reliability, creativity, organization
  enabled     Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
}

// ============================================
// POSITIONING ANGLES - How to frame the pen
// ============================================

model PositioningAngle {
  id          String   @id @default(cuid())
  userNeed    String   @unique // professionalism, reliability, creativity, organization, status, gift
  headline    String
  pitch       String
  emotionalHook String
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
}

// ============================================
// CLOSING STRATEGIES
// ============================================

model ClosingStrategy {
  id          String   @id @default(cuid())
  name        String   @unique
  type        String   // assumptive, soft, urgency, choice, summary
  script      String
  useWhen     String   // When to use this close
  enabled     Boolean  @default(true)
  successRate Float    @default(0)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
}

// ============================================
// OBJECTION HANDLERS
// ============================================

model ObjectionHandler {
  id          String   @id @default(cuid())
  objection   String   // The objection (e.g., "too expensive", "don't need it")
  category    String   // price, need, timing, trust, competition
  response    String   // How to handle it
  technique   String   // Name of technique (e.g., "feel-felt-found", "reframe")
  enabled     Boolean  @default(true)
  createdAt   DateTime @default(now())
}

// ============================================
// AI SYSTEM PROMPT - Configurable AI instructions
// ============================================

model AIPromptConfig {
  id              String   @id @default(cuid())
  name            String   @unique @default("default")
  systemPrompt    String   // Main AI instructions
  discoveryPrompt String   // Instructions for discovery phase
  positioningPrompt String // Instructions for positioning phase
  closingPrompt   String   // Instructions for closing phase
  enabled         Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ============================================
// GLOBAL ANALYTICS - Aggregate learning data
// ============================================

model GlobalAnalytics {
  id                      String   @id @default(cuid())
  date                    DateTime @default(now()) @unique
  totalSessions           Int      @default(0)
  successfulSales         Int      @default(0)
  failedSales             Int      @default(0)
  abandonedSessions       Int      @default(0)
  avgSessionDuration      Float    @default(0)
  avgMessagesToClose      Float    @default(0)
  conversionRate          Float    @default(0)
  topPerformingTechnique  String?
  mostCommonObjection     String?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
}

// ============================================
// LEARNING INSIGHTS - AI-generated insights
// ============================================

model LearningInsight {
  id          String   @id @default(cuid())
  type        String   // technique_effectiveness, objection_pattern, conversion_insight
  insight     String
  confidence  Float    @default(0)
  basedOn     Int      @default(0) // Number of sessions this is based on
  createdAt   DateTime @default(now())
}

// ============================================
// BRANDING & SETTINGS
// ============================================

model Branding {
  id              String   @id @default(cuid())
  logoUrl         String   @default("")
  faviconUrl      String   @default("")
  primaryColor    String   @default("#b45309") // Western Brown/Amber
  secondaryColor  String   @default("#92400e")
  accentColor     String   @default("#d97706")
  headingFont     String   @default("Inter")
  bodyFont        String   @default("Inter")
  updatedAt       DateTime @updatedAt
}

model StoreInfo {
  id              String   @id @default(cuid())
  businessName    String   @default("SellMe PRT")
  tagline         String   @default("Western Sales Training")
  description     String   @default("AI-powered western wear sales training platform")
  address         String   @default("")
  phone           String   @default("")
  email           String   @default("")
  website         String   @default("")
  businessHours   String   @default("")
  timezone        String   @default("America/New_York")
  updatedAt       DateTime @updatedAt
}

model Features {
  id                      String   @id @default(cuid())
  faqEnabled              Boolean  @default(false)
  stickyBarEnabled        Boolean  @default(false)
  stickyBarText           String   @default("")
  stickyBarBgColor        String   @default("#b45309")
  stickyBarLink           String   @default("")
  stickyBarLinkText       String   @default("")
  liveChatEnabled         Boolean  @default(false)
  chatProvider            String   @default("builtin")
  chatWelcomeMessage      String   @default("Hi! How can we help you today?")
  chatAgentName           String   @default("Support")
  chatWidgetColor         String   @default("#b45309")
  chatPosition            String   @default("bottom-right")
  chatShowOnMobile        Boolean  @default(true)
  chatWidgetId            String   @default("")
  chatEmbedCode           String   @default("")
  emailNotifications      Boolean  @default(true)
  smsNotifications        Boolean  @default(false)
  pushNotifications       Boolean  @default(false)
  orderConfirmations      Boolean  @default(true)
  marketingEmails         Boolean  @default(false)
  appointmentReminders    Boolean  @default(true)
  facebookEnabled         Boolean  @default(false)
  facebookUrl             String   @default("")
  twitterEnabled          Boolean  @default(false)
  twitterUrl              String   @default("")
  instagramEnabled        Boolean  @default(false)
  instagramUrl            String   @default("")
  linkedinEnabled         Boolean  @default(false)
  linkedinUrl             String   @default("")
  youtubeEnabled          Boolean  @default(false)
  youtubeUrl              String   @default("")
  tiktokEnabled           Boolean  @default(false)
  tiktokUrl               String   @default("")
  shareOnFacebook         Boolean  @default(true)
  shareOnTwitter          Boolean  @default(true)
  shareOnLinkedin         Boolean  @default(false)
  shareOnWhatsapp         Boolean  @default(true)
  shareOnEmail            Boolean  @default(true)
  copyLinkButton          Boolean  @default(true)
  updatedAt               DateTime @updatedAt
}

model PaymentSettings {
  id                    String   @id @default(cuid())
  enabled               Boolean  @default(false)
  stripeEnabled         Boolean  @default(false)
  stripePublishableKey  String   @default("")
  stripeTestMode        Boolean  @default(true)
  paypalEnabled         Boolean  @default(false)
  paypalClientId        String   @default("")
  paypalSandbox         Boolean  @default(true)
  squareEnabled         Boolean  @default(false)
  squareAppId           String   @default("")
  squareSandbox         Boolean  @default(true)
  updatedAt             DateTime @updatedAt
}

// ============================================
// AI AGENTS
// ============================================

model AIAgent {
  id           String   @id @default(cuid())
  name         String
  description  String?
  systemPrompt String?
  model        String   @default("gpt-4o-realtime")
  voice        String   @default("alloy")
  temperature  Float    @default(0.7)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ============================================
// AI TOOLS
// ============================================

model AITool {
  id          String   @id @default(cuid())
  name        String
  description String?
  type        String   @default("function") // function, api, webhook
  schema      String   @default("{}") // JSON schema
  endpoint    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// KNOWLEDGE BASE
// ============================================

model KnowledgeDoc {
  id        String   @id @default(cuid())
  title     String
  slug      String   @unique
  language  String   @default("en")
  content   String
  createdAt DateTime @default(now())
  chunks    KnowledgeChunk[]
}

model KnowledgeChunk {
  id        String       @id @default(cuid())
  docId     String
  doc       KnowledgeDoc @relation(fields: [docId], references: [id], onDelete: Cascade)
  index     Int
  text      String
  embedding String       // JSON array of numbers
  createdAt DateTime     @default(now())
}

// ============================================
// WEBHOOKS
// ============================================

model Webhook {
  id        String   @id @default(cuid())
  name      String
  url       String
  events    String   @default("[]") // JSON array of event types
  secret    String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// SMS SETTINGS
// ============================================

model SMSSettings {
  id             String   @id @default(cuid())
  provider       String   @default("twilio") // twilio, vonage, etc.
  accountSid     String?
  authToken      String?
  fromNumber     String?
  enableReminders Boolean @default(true)
  reminderHours  Int      @default(24)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// ============================================
// CALL TRANSFER
// ============================================

model CallTransfer {
  id          String   @id @default(cuid())
  name        String
  description String?
  phoneNumber String
  sipUri      String?
  priority    Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// DTMF MENU
// ============================================

model DTMFMenu {
  id        String   @id @default(cuid())
  name      String
  digit     String   // 0-9, *, #
  action    String   // transfer, repeat, skip, end
  targetId  String?  // Reference to target (e.g., transfer number)
  prompt    String?  // Voice prompt to play
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// LOGIC RULES
// ============================================

model LogicRule {
  id          String   @id @default(cuid())
  name        String
  description String?
  trigger     String   // event that triggers the rule
  conditions  String   @default("[]") // JSON array of conditions
  actions     String   @default("[]") // JSON array of actions
  priority    Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// FUNCTIONS (Custom Code)
// ============================================

model Function {
  id          String   @id @default(cuid())
  name        String
  description String?
  code        String   // JavaScript code
  parameters  String   @default("[]") // JSON array of parameters
  returnType  String   @default("void")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// COMPANY MANAGEMENT
// ============================================

model Company {
  id        String   @id @default(cuid())
  name      String
  domain    String   @unique
  settings  String   @default("{}") // JSON settings
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  users     User[]
}

model User {
  id        String   @id @default(cuid())
  email     String
  username  String?
  password  String
  name      String
  role      String   @default("MANAGER") // COMPANY_ADMIN, MANAGER
  isActive  Boolean  @default(true)
  companyId String
  company   Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([email, companyId])
  @@index([companyId])
}

// ============================================
// PAYMENTS
// ============================================

model Payment {
  id            String   @id @default(cuid())
  amount        Float
  currency      String   @default("USD")
  status        String   @default("pending") // pending, completed, failed, refunded
  method        String?  // card, bank, paypal
  transactionId String?
  description   String?
  companyId     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([companyId])
  @@index([status])
}
